(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const i of e.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function s(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function o(t){if(t.ep)return;t.ep=!0;const e=s(t);fetch(t.href,e)}})();function B(r){const n=document.getElementById("main-menu"),s=document.getElementById("account-creation-container"),o=document.getElementById("start-button"),t=document.getElementById("account-button"),e=document.getElementById("settings-button"),i=document.getElementById("instructions-button"),l=document.getElementById("projects-button"),c=document.getElementById("vr-button"),y=document.getElementById("guest-mode-button"),h=document.getElementById("create-account-file-button"),f=document.getElementById("login-file-button"),d=document.getElementById("login-file-input"),a=document.getElementById("ar-instructions"),g=document.getElementById("close-instructions-button"),p=document.getElementById("ar-container"),b=document.getElementById("ar-ui"),E=document.getElementById("ar-select-object-button"),u=document.getElementById("ar-object-menu");E.addEventListener("click",()=>{u.style.display=u.style.display==="none"?"block":"none"}),t.addEventListener("click",()=>{s.style.display="flex",t.style.display="none"}),y.addEventListener("click",()=>{r.startGuestMode(),o.disabled=!1,s.style.display="none"}),h.addEventListener("click",()=>{r.createAccountWithFile(),o.disabled=!1,s.style.display="none"}),f.addEventListener("click",()=>{d.click()}),d.addEventListener("change",w=>{const m=w.target.files[0];m&&(r.loginWithFile(m),o.disabled=!1,s.style.display="none")}),o.addEventListener("click",()=>{n.style.display="none",a.style.display="block"}),g.addEventListener("click",()=>{a.style.display="none",p.style.display="block",b.style.display="flex",r.startAR()}),c.addEventListener("click",()=>{alert("VR mode is not implemented yet.")}),e.addEventListener("click",()=>{alert("Settings are not implemented yet.")}),i.addEventListener("click",()=>{window.open("https://github.com/ten-tools-of-the-new-world/vestigium/blob/main/docs/USER_GUIDE.md","_blank")}),l.addEventListener("click",()=>{window.open("https://github.com/ten-tools-of-the-new-world","_blank")})}class I{constructor(){this.ipfs=null,this.orbitdb=null,this.db=null,this.friendsDb=null,this.userDid=null,this.currentPosition=null,this.map=null,this.userMarker=null,this.scene=document.querySelector("a-scene"),this.markerEntity=document.getElementById("marker-entity"),this.selectedEntity=null,this.init()}async init(){await this.initDID(),this.initMap(),B(this)}async initDID(){const{DidKey:n}=DidKeyWebCrypto,s=new n,o=localStorage.getItem("userDid");o?this.userDid=await s.fromDid(o):(this.userDid=await s.generate(),localStorage.setItem("userDid",this.userDid.did),localStorage.setItem("privateKey",JSON.stringify(await this.userDid.export({type:"JsonWebKey2020",privateKey:!0})))),console.log("User DID:",this.userDid.did)}initMap(){this.map=L.map("map").setView([0,0],2),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.map),navigator.geolocation.getCurrentPosition(n=>{this.currentPosition={latitude:n.coords.latitude,longitude:n.coords.longitude},this.map.setView([this.currentPosition.latitude,this.currentPosition.longitude],13),this.userMarker?this.userMarker.setLatLng([this.currentPosition.latitude,this.currentPosition.longitude]):this.userMarker=L.marker([this.currentPosition.latitude,this.currentPosition.longitude]).addTo(this.map)})}startGuestMode(){console.log("Starting in Guest Mode")}createAccountWithFile(){console.log("Creating account with file..."),alert("Account creation with file is not fully implemented yet.")}loginWithFile(n){console.log(`Logging in with file: ${n.name}`),alert("Login with file is not fully implemented yet.")}async startAR(){console.log("Starting AR experience"),this.ipfs||(this.ipfs=await Ipfs.create(),this.orbitdb=await OrbitDB.createInstance(this.ipfs),this.db=await this.orbitdb.keyvalue("vestigium-db"),this.friendsDb=await this.orbitdb.keyvalue("friends-db"),this.loadARObjects())}async loadARObjects(){const n=this.map.getBounds(),s=await this.db.all();for(const o in s){const t=s[o];if(t.latitude&&t.longitude&&n.contains([t.latitude,t.longitude])){let e=!1;if((t.visibility==="public"||t.visibility==="private"&&t.author===this.userDid.id||t.visibility==="friends"&&(this.friendsDb.get(this.userDid.id)||[]).includes(t.author))&&(e=!0),e){const i=document.createElement("a-entity");i.setAttribute("gltf-model",`url(https://ipfs.io/ipfs/${t.cid})`),i.setAttribute("position",t.position),i.setAttribute("scale",t.scale),i.setAttribute("rotation",t.rotation),i.setAttribute("animation-mixer",""),this.markerEntity.appendChild(i),i.addEventListener("click",()=>{this.selectedEntity&&this.selectedEntity.getObject3D("mesh")&&this.selectedEntity.removeObject3D("mesh"),this.selectedEntity=i;const l=this.selectedEntity.getObject3D("mesh");if(l){const c=new THREE.LineSegments(new THREE.WireframeGeometry(l.geometry),new THREE.LineBasicMaterial({color:16777215}));this.selectedEntity.setObject3D("mesh",c)}})}}}}}window.onload=()=>{new I};
